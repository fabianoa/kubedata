apiVersion: v1
# ===============LICENSE_START=======================================================
# Acumos Apache-2.0
# ===================================================================================
# Copyright (C) 2019 AT&T Intellectual Property. All rights reserved.
# ===================================================================================
# This Acumos software file is distributed by AT&T
# under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# This file is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ===============LICENSE_END=========================================================
kind: ConfigMap
metadata:
  name: nifi-registry-apache-configmap
data:
  httpd.conf: |-
    ServerRoot "/usr/local/apache2"
    Listen 8080
    LoadModule mpm_event_module modules/mod_mpm_event.so
    #LoadModule mpm_prefork_module modules/mod_mpm_prefork.so
    #LoadModule mpm_worker_module modules/mod_mpm_worker.so
    LoadModule authn_file_module modules/mod_authn_file.so
    #LoadModule authn_dbm_module modules/mod_authn_dbm.so
    #LoadModule authn_anon_module modules/mod_authn_anon.so
    #LoadModule authn_dbd_module modules/mod_authn_dbd.so
    #LoadModule authn_socache_module modules/mod_authn_socache.so
    LoadModule authn_core_module modules/mod_authn_core.so
    LoadModule authz_host_module modules/mod_authz_host.so
    LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
    LoadModule authz_user_module modules/mod_authz_user.so
    #LoadModule authz_dbm_module modules/mod_authz_dbm.so
    #LoadModule authz_owner_module modules/mod_authz_owner.so
    #LoadModule authz_dbd_module modules/mod_authz_dbd.so
    LoadModule authz_core_module modules/mod_authz_core.so
    #LoadModule authnz_ldap_module modules/mod_authnz_ldap.so
    #LoadModule authnz_fcgi_module modules/mod_authnz_fcgi.so
    LoadModule access_compat_module modules/mod_access_compat.so
    LoadModule auth_basic_module modules/mod_auth_basic.so
    #LoadModule auth_form_module modules/mod_auth_form.so
    #LoadModule auth_digest_module modules/mod_auth_digest.so
    #LoadModule allowmethods_module modules/mod_allowmethods.so
    #LoadModule isapi_module modules/mod_isapi.so
    #LoadModule file_cache_module modules/mod_file_cache.so
    #LoadModule cache_module modules/mod_cache.so
    #LoadModule cache_disk_module modules/mod_cache_disk.so
    #LoadModule cache_socache_module modules/mod_cache_socache.so
    #LoadModule socache_shmcb_module modules/mod_socache_shmcb.so
    #LoadModule socache_dbm_module modules/mod_socache_dbm.so
    #LoadModule socache_memcache_module modules/mod_socache_memcache.so
    #LoadModule socache_redis_module modules/mod_socache_redis.so
    #LoadModule watchdog_module modules/mod_watchdog.so
    #LoadModule macro_module modules/mod_macro.so
    #LoadModule dbd_module modules/mod_dbd.so
    #LoadModule bucketeer_module modules/mod_bucketeer.so
    #LoadModule dumpio_module modules/mod_dumpio.so
    #LoadModule echo_module modules/mod_echo.so
    #LoadModule example_hooks_module modules/mod_example_hooks.so
    #LoadModule case_filter_module modules/mod_case_filter.so
    #LoadModule case_filter_in_module modules/mod_case_filter_in.so
    #LoadModule example_ipc_module modules/mod_example_ipc.so
    #LoadModule buffer_module modules/mod_buffer.so
    #LoadModule data_module modules/mod_data.so
    #LoadModule ratelimit_module modules/mod_ratelimit.so
    LoadModule reqtimeout_module modules/mod_reqtimeout.so
    #LoadModule ext_filter_module modules/mod_ext_filter.so
    #LoadModule request_module modules/mod_request.so
    #LoadModule include_module modules/mod_include.so
    LoadModule filter_module modules/mod_filter.so
    #LoadModule reflector_module modules/mod_reflector.so
    #LoadModule substitute_module modules/mod_substitute.so
    #LoadModule sed_module modules/mod_sed.so
    #LoadModule charset_lite_module modules/mod_charset_lite.so
    #LoadModule deflate_module modules/mod_deflate.so
    #LoadModule xml2enc_module modules/mod_xml2enc.so
    #LoadModule proxy_html_module modules/mod_proxy_html.so
    LoadModule mime_module modules/mod_mime.so
    #LoadModule ldap_module modules/mod_ldap.so
    LoadModule log_config_module modules/mod_log_config.so
    #LoadModule log_debug_module modules/mod_log_debug.so
    #LoadModule log_forensic_module modules/mod_log_forensic.so
    #LoadModule logio_module modules/mod_logio.so
    #LoadModule lua_module modules/mod_lua.so
    LoadModule env_module modules/mod_env.so
    #LoadModule mime_magic_module modules/mod_mime_magic.so
    #LoadModule cern_meta_module modules/mod_cern_meta.so
    #LoadModule expires_module modules/mod_expires.so
    LoadModule headers_module modules/mod_headers.so
    #LoadModule ident_module modules/mod_ident.so
    #LoadModule usertrack_module modules/mod_usertrack.so
    #LoadModule unique_id_module modules/mod_unique_id.so
    LoadModule setenvif_module modules/mod_setenvif.so
    LoadModule version_module modules/mod_version.so
    #LoadModule remoteip_module modules/mod_remoteip.so
    #LoadModule proxy_module modules/mod_proxy.so
    #LoadModule proxy_connect_module modules/mod_proxy_connect.so
    #LoadModule proxy_ftp_module modules/mod_proxy_ftp.so
    #LoadModule proxy_http_module modules/mod_proxy_http.so
    #LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
    #LoadModule proxy_scgi_module modules/mod_proxy_scgi.so
    #LoadModule proxy_uwsgi_module modules/mod_proxy_uwsgi.so
    #LoadModule proxy_fdpass_module modules/mod_proxy_fdpass.so
    #LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
    #LoadModule proxy_ajp_module modules/mod_proxy_ajp.so
    #LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
    #LoadModule proxy_express_module modules/mod_proxy_express.so
    #LoadModule proxy_hcheck_module modules/mod_proxy_hcheck.so
    #LoadModule session_module modules/mod_session.so
    #LoadModule session_cookie_module modules/mod_session_cookie.so
    #LoadModule session_crypto_module modules/mod_session_crypto.so
    #LoadModule session_dbd_module modules/mod_session_dbd.so
    #LoadModule slotmem_shm_module modules/mod_slotmem_shm.so
    #LoadModule slotmem_plain_module modules/mod_slotmem_plain.so
    #LoadModule ssl_module modules/mod_ssl.so
    #LoadModule optional_hook_export_module modules/mod_optional_hook_export.so
    #LoadModule optional_hook_import_module modules/mod_optional_hook_import.so
    #LoadModule optional_fn_import_module modules/mod_optional_fn_import.so
    #LoadModule optional_fn_export_module modules/mod_optional_fn_export.so
    #LoadModule dialup_module modules/mod_dialup.so
    #LoadModule http2_module modules/mod_http2.so
    #LoadModule proxy_http2_module modules/mod_proxy_http2.so
    #LoadModule lbmethod_byrequests_module modules/mod_lbmethod_byrequests.so
    #LoadModule lbmethod_bytraffic_module modules/mod_lbmethod_bytraffic.so
    #LoadModule lbmethod_bybusyness_module modules/mod_lbmethod_bybusyness.so
    #LoadModule lbmethod_heartbeat_module modules/mod_lbmethod_heartbeat.so
    LoadModule unixd_module modules/mod_unixd.so
    #LoadModule heartbeat_module modules/mod_heartbeat.so
    #LoadModule heartmonitor_module modules/mod_heartmonitor.so
    #LoadModule dav_module modules/mod_dav.so
    LoadModule status_module modules/mod_status.so
    LoadModule autoindex_module modules/mod_autoindex.so
    #LoadModule asis_module modules/mod_asis.so
    #LoadModule info_module modules/mod_info.so
    #LoadModule suexec_module modules/mod_suexec.so
    <IfModule !mpm_prefork_module>
    	#LoadModule cgid_module modules/mod_cgid.so
    </IfModule>
    <IfModule mpm_prefork_module>
    	#LoadModule cgi_module modules/mod_cgi.so
    </IfModule>
    #LoadModule dav_fs_module modules/mod_dav_fs.so
    #LoadModule dav_lock_module modules/mod_dav_lock.so
    #LoadModule vhost_alias_module modules/mod_vhost_alias.so
    #LoadModule negotiation_module modules/mod_negotiation.so
    LoadModule dir_module modules/mod_dir.so
    #LoadModule imagemap_module modules/mod_imagemap.so
    #LoadModule actions_module modules/mod_actions.so
    #LoadModule speling_module modules/mod_speling.so
    #LoadModule userdir_module modules/mod_userdir.so
    LoadModule alias_module modules/mod_alias.so
    #LoadModule rewrite_module modules/mod_rewrite.so
    <IfModule unixd_module>
    User daemon
    Group daemon
    </IfModule>
    ServerAdmin you@example.com
    <Directory />
        AllowOverride none
        Require all denied
    </Directory>
    DocumentRoot "/usr/local/apache2/htdocs"
    <Directory "/usr/local/apache2/htdocs">
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>
    <IfModule dir_module>
        DirectoryIndex index.html
    </IfModule>
    <Files ".ht*">
        Require all denied
    </Files>
    ErrorLog /proc/self/fd/2
    LogLevel warn
    <IfModule log_config_module>
      LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
      LogFormat "%h %l %u %t \"%r\" %>s %b" common
      <IfModule logio_module>
        LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O" combinedio
      </IfModule>
      CustomLog /proc/self/fd/1 common
    </IfModule>
    <IfModule alias_module>
        ScriptAlias /cgi-bin/ "/usr/local/apache2/cgi-bin/"
    </IfModule>
    <IfModule cgid_module>
    </IfModule>
    <Directory "/usr/local/apache2/cgi-bin">
        AllowOverride None
        Options None
        Require all granted
    </Directory>
    <IfModule headers_module>
        RequestHeader unset Proxy early
    </IfModule>
    <IfModule mime_module>
        TypesConfig conf/mime.types
        AddType application/x-compress .Z
        AddType application/x-gzip .gz .tgz
    </IfModule>
    <IfModule proxy_html_module>
    Include conf/extra/proxy-html.conf
    </IfModule>
    <IfModule ssl_module>
    SSLRandomSeed startup builtin
    SSLRandomSeed connect builtin
    </IfModule>
    Include conf/extra/local.conf
  local.conf: |-
    LoadModule authz_host_module modules/mod_authz_host.so
    LoadModule authz_core_module modules/mod_authz_core.so
    LoadModule access_compat_module modules/mod_access_compat.so
    LoadModule include_module modules/mod_include.so
    LoadModule filter_module modules/mod_filter.so
    LoadModule deflate_module modules/mod_deflate.so
    LoadModule mime_module modules/mod_mime.so
    LoadModule log_config_module modules/mod_log_config.so
    LoadModule env_module modules/mod_env.so
    LoadModule setenvif_module modules/mod_setenvif.so
    LoadModule proxy_module modules/mod_proxy.so
    LoadModule proxy_http_module modules/mod_proxy_http.so
    LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
    LoadModule slotmem_shm_module modules/mod_slotmem_shm.so
    LoadModule lbmethod_byrequests_module modules/mod_lbmethod_byrequests.so
    LoadModule ssl_module modules/mod_ssl.so
    LoadModule alias_module modules/mod_alias.so
    LoadModule rewrite_module modules/mod_rewrite.so
    LoadModule negotiation_module modules/mod_negotiation.so
    LoadModule dir_module modules/mod_dir.so
    LoadModule autoindex_module modules/mod_autoindex.so
    LoadModule unixd_module modules/mod_unixd.so
    LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
    LoadModule proxy_scgi_module modules/mod_proxy_scgi.so
    LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
    LoadModule proxy_ajp_module modules/mod_proxy_ajp.so
    LoadModule proxy_connect_module modules/mod_proxy_connect.so
    LoadModule proxy_ftp_module modules/mod_proxy_ftp.so
    ProxyRequests On
    ProxyVia on
    ProxyPreserveHost Off
    SSLEngine On
    SSLProtocol                         all -SSLv2 -SSLv3
    SSLCipherSuite                      ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS
    SSLHonorCipherOrder                 on
    SSLOptions                          +StrictRequire
    SSLCertificateFile                  /etc/letsencrypt/live/${server_name}/cert.pem
    SSLCertificateKeyFile               /etc/letsencrypt/live/${server_name}/privkey.pem
    SSLCertificateChainFile             /etc/letsencrypt/live/${server_name}/fullchain.pem

    AllowCONNECT 1-60000
    <IF "%{HTTP:authuser} != ''">
            RewriteEngine on
            RewriteRule .* - [E=RU:%{HTTP:authuser}]
            RequestHeader set X-ProxiedEntitiesChain "%{RU}e"
    </IF>
    <Else>
            RequestHeader set X-ProxiedEntitiesChain "unauth_noaccess_user"
    </Else>
    ProxyPass /nifi-registry/ https://localhost:8443/nifi-registry/
    ProxyPass /nifi-registry-api/ https://localhost:8443/nifi-registry-api/
    <Directory "/var/www/html">
        Options Indexes FollowSymLinks Includes
        AllowOverride None
        Require all granted
    </Directory>
---
apiVersion: v1
kind: Secret
metadata:
  name: nifi-keystore-secret
type: Opaque
data:
  keystore.jks: |-
    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
  truststore.jks: |-
    /u3+7QAAAAIAAAABAAAAAgAJbmlmaS1jZXJ0AAABh1zbmywABVguNTA5AAADZTCCA2EwggJJoAMC
    AQICCgGHXNuaRAAAAAAwDQYJKoZIhvcNAQELBQAwIzENMAsGA1UECwwETklGSTESMBAGA1UEAwwJ
    bG9jYWxob3N0MB4XDTIzMDQwNzE3NTUwOFoXDTI1MDcxMDE3NTUwOFowIzENMAsGA1UECwwETklG
    STESMBAGA1UEAwwJbG9jYWxob3N0MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAki/X
    6v9qJ1ogfQlrA6PjswWrbegee01+0sWnSEIMJx8nZEefShnVbFbA7Dls9/q2mSaOHjFGAXmhDwoG
    weoQtKkddhKq8WIxFd2HGkxqT1CeDW9MVdKqVLMdf2Ez53eVASmKLtu5Pw3MxbEPolzsV2rw8oTq
    r2D/g8ZbMvtmXFdc9nwUaTtW6uduuQAVBCQddy2vdjS8l9gykJqWhKKBnLMLb89532xTdFKzalFx
    nXeWuWkOmgqzBnjTjEapKKCML5m39IxgiS2MQc1s4A9bGRQ7B0inhPDI+JjutdHSAm03uc5Akn24
    Fk6Bi5e8ZT53xyQIUHSqu99OMeQGpoiPaQIDAQABo4GWMIGTMA4GA1UdDwEB/wQEAwIB/jAMBgNV
    HRMEBTADAQH/MB0GA1UdDgQWBBS7vj4hBwo3m36i+7ldTrx2XoV0FTAfBgNVHSMEGDAWgBS7vj4h
    Bwo3m36i+7ldTrx2XoV0FTAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEwFAYDVR0RBA0w
    C4IJbG9jYWxob3N0MA0GCSqGSIb3DQEBCwUAA4IBAQCJkz04eoMAAhw3nh/4laCumOn8oTj5w0+4
    nuvk55BR07gsU+8EJFMI1TZV2+zdtSfJEEe/prytaO711MU8VZd3Q5I+s8b76oCEc6w/6Y/WKIFO
    ZtqOKZ04kpL4T+KsOtRyswQ8Xr2L1oVx/iXVKfQr/MvvQpa73BML8iv8tXM+nyZha2axcgJsX6Nx
    u5WEMBejCXdSrihsxE4Zoa/p/C7xQpgzMc9rjrjx0MYIw0BUWom3sTguPPWwtBUv8ZMh+4yCGkxU
    a1mlnQ3+AWzrthVS+QwFazjuvJZ9XBj5Ro9teJ9RgVpDutsLo2vdbX+76lFNrI4b65Tbj9PD5Joo
    YGIyC4CreIrwkwcb3BpRx7kOSVC/Uh0=
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nifi-registry
  labels:
    app: nifi-registry
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nifi-registry
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: nifi-registry
    spec:
      containers:
      - name: apache
        image: "lets-encrypt-apache:latest"
        #command: ['/bin/bash', '-c']
        #args:
        #- apachectl configtest;
        ports:
        - containerPort: 8080
          protocol: TCP
        volumeMounts:
        - mountPath: /usr/local/apache2/conf/httpd.conf
          name: apache-configmap
          subPath: httpd.conf
        - mountPath: /usr/local/apache2/conf/extra/local.conf
          name: apache-configmap
          subPath: local.conf
        - mountPath: /opt/sslkey
          name: nifi-certs
        resources:
          limits:
            cpu: "0.5"
            memory: "500Mi"
          requests:
            cpu: "0.5"
            memory: "500Mi"
      - name: nifi-registry
        image: apache/nifi-registry:1.20.0
        env:
        - name: AUTH
          value: "tls"
        - name: CERT_KEY_PASSWORD
          value: "7+55VSQP258Z0Yz6iRYMOkambkVvJH8aDadKpsbJ3nU"
        - name: KEYSTORE_PATH
          value: "/opt/nifi-registry/certs/keystore.jks"
        - name: KEYSTORE_TYPE
          value: "JKS"
        - name: KEYSTORE_PASSWORD
          value: "7+55VSQP258Z0Yz6iRYMOkambkVvJH8aDadKpsbJ3nU"
        - name: TRUSTSTORE_PATH
          value: "/opt/nifi-registry/certs/truststore.jks"
        - name: TRUSTSTORE_TYPE
          value: "JKS"
        - name: TRUSTSTORE_PASSWORD
          value: "rbHx2dfTn/vhpzDQwrnJt0j0hPb7He29hfe68M2TuFs"
        - name: INITIAL_ADMIN_IDENTITY
          value: "CN=Admin, OU=Nifi"
        command: ['/bin/bash', '-c']
        args:
        - set -x;
          mkdir /opt/nifi-registry/certs/;
          cp /conf/certs/* /opt/nifi-registry/certs/.;
          chmod 744 /opt/nifi-registry/certs/*;
          ls -lat /opt/nifi-registry/certs;
          keytool -list -keystore $$KEYSTORE_PATH -storetype JKS -storepass $$KEYSTORE_PASSWORD;
          sed -i -- "s~nifi.registry.security.needClientAuth=.*~nifi.registry.security.needClientAuth=true~" conf/nifi-registry.properties;
          sed -i -- "s~nifi.registry.security.keyPasswd=.*~nifi.registry.security.keyPasswd=$$CERT_KEY_PASSWORD~" conf/nifi-registry.properties;
          sed -i -- "s~nifi.registry.security.keystore=.*~nifi.registry.security.keystore=$$KEYSTORE_PATH~" conf/nifi-registry.properties;
          sed -i -- "s~nifi.registry.security.keystoreType=.*~nifi.registry.security.keystoreType=$$KEYSTORE_TYPE~" conf/nifi-registry.properties;
          sed -i -- "s~nifi.registry.security.keystorePasswd=.*~nifi.registry.security.keystorePasswd=$$KEYSTORE_PASSWORD~" conf/nifi-registry.properties;
          sed -i -- "s~nifi.registry.security.truststore=.*~nifi.registry.security.truststore=$$TRUSTSTORE_PATH~" conf/nifi-registry.properties;
          sed -i -- "s~nifi.registry.security.truststoreType=.*~nifi.registry.security.truststoreType=$$TRUSTSTORE_TYPE~" conf/nifi-registry.properties;
          sed -i -- "s~nifi.registry.security.truststorePasswd=.*~nifi.registry.security.truststorePasswd=$$TRUSTSTORE_PASSWORD~" conf/nifi-registry.properties;
          sed -i -- "s~nifi.registry.web.https.host=.*~nifi.registry.web.https.host=0.0.0.0~" conf/nifi-registry.properties;
          sed -i -- "s~nifi.registry.web.https.port=.*~nifi.registry.web.https.port=8443~" conf/nifi-registry.properties;
          sed -i -- "s~nifi.registry.web.http.host=.*~nifi.registry.web.http.host=~" conf/nifi-registry.properties;
          sed -i -- "s~nifi.registry.web.http.port=.*~nifi.registry.web.http.port=~" conf/nifi-registry.properties;
          sed -i -- "s~nifi.remote.input.http.enabled=.*~nifi.remote.input.http.enabled=~" conf/nifi-registry.properties;
          sed -i -- "s~\"Initial User Identity 1\"><~\"Initial User Identity 1\">$$INITIAL_ADMIN_IDENTITY<~g" conf/authorizers.xml;
          sed -i -- "s~\"Initial Admin Identity\"><~\"Initial Admin Identity\">$$INITIAL_ADMIN_IDENTITY<~g" conf/authorizers.xml;
          sed -i -- "s~\"NiFi Identity 1\"><~\"NiFi Identity 1\">$$INITIAL_ADMIN_IDENTITY<~g" conf/authorizers.xml;
          sed -i -- "s~# nifi.registry.security.identity.mapping.pattern.dn~ nifi.registry.security.identity.mapping.pattern.dn~" conf/nifi-registry.properties;
          sed -i -- "s~# nifi.registry.security.identity.mapping.value.dn=\$1@\$2~ nifi.registry.security.identity.mapping.value.dn=\$1~" conf/nifi-registry.properties;
          echo "authorizers.xml:";
          cat conf/authorizers.xml;
          echo "nifi-registry.properties:";
          cat conf/nifi-registry.properties;
          sed -i -- "s~prop_replace 'nifi.registry.web.http~#prop_replace 'nifi.registry.web.http~g" ../scripts/start.sh;
          sed -i -- 's~. "${scripts_dir}/secure.sh"~#. "${scripts_dir}/secure.sh"~g' ../scripts/start.sh;
          cat ../scripts/start.sh;
         ../scripts/start.sh;
        ports:
        - containerPort: 8443
        volumeMounts:
        - mountPath: /conf/certs/
          name: nifi-certs
      restartPolicy: Always
      volumes:
      - name: apache-configmap
        configMap:
          name: nifi-registry-apache-configmap
      - name: nifi-certs
        secret:
          secretName: nifi-keystore-secret